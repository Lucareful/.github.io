<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Golang pprof 性能分析指南 | Luenci</title>
<meta name="keywords" content="golang">
<meta name="description" content="Golang pprof 性能分析指南

pprof 是一个用于可视化和分析分析数据的工具。

采样方式



方式名称
如何使用
优点
缺点
使用场景




runtime/pprof
手动调用【runtime.StartCPUProfile、runtime.SweightCPUProfile】等API来进行数据的采集。采集程序（非 Server）的指定区块的运行数据进行分析。
灵活性高、按需采集。

工具型应用（比如说定制化的分析小工具、集成到公司监控系统）。这种应用运行一段时间就结束。


net/http/pprof
通过http服务来获取Profile采样文件。 import _ &quot;net/http/pprof&quot;。基于 HTTP Server 运行，并且可以采集运行时数据进行分析。net/http/pprof中只是使用runtime/pprof包来进行封装了一下，并在http端口上暴露出来
简单易用

在线服务（一直运行着的程序）


go test
通过命令go test -bench . -cpuprofile cpu.prof来进行采集数据。
针对性强、细化到函数

进行某函数的性能测试



指标解释


常用指标如下：


allocs：所有时刻的内存使用情况，包括正在使用的及已经回收的


block：导致在同步原语上发生阻塞的堆栈跟踪


cmdline： 当前程序的命令行的完整调用路径。


goroutine：目前的 goroutine 数量及运行情况


heap：当前时刻的内存使用情况


mutex：查看导致互斥锁的竞争持有者的堆栈跟踪


profile：默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件


threadcreate：查看创建新 OS 线程的堆栈跟踪。


trance：当前程序执行的追踪，可以在秒数的 GET 参数中指定持续时间。在获取追踪文件后，请使用 go 工具的 trace 命令来调查追踪。（深入浅出 Go trace (qq.com)）



注意，默认情况下是不追踪block和mutex的信息的，如果想要看这两个信息，需要在代码中加上两行：


1
2


runtime.SetBlockProfileRate(1) // 开启对阻塞操作的跟踪，block  
runtime.SetMutexProfileFraction(1) // 开启对锁调用的跟踪，mutex



​	注意，上文的所有信息都是实时的，如果你刷新一下，是可以看到数字在变化的。此时如果点击蓝色的连接，可以看到一些协程的栈信息，这些信息并不容易阅读。如果想要更加清晰的数据，需要将信息保存下来，在本地进行分析。">
<meta name="author" content="Luenci">
<link rel="canonical" href="http://localhost:1313/articles/1/01/golang-pprof-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.54405a410796490bc874ab6181fac9b675753cc2b91375d8f882566459eca428.css" integrity="sha256-VEBaQQeWSQvIdKthgfrJtnV1PMK5E3XY&#43;IJWZFnspCg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/articles/1/01/golang-pprof-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Luenci (Alt + H)">Luenci</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/index.xml" title="RSS Feed">
                    <span>RSS Feed</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Golang pprof 性能分析指南
    </h1>
    <div class="post-meta">Luenci

</div>
  </header> 
  <div class="post-content"><h1 id="golang-pprof-性能分析指南">Golang pprof 性能分析指南<a hidden class="anchor" aria-hidden="true" href="#golang-pprof-性能分析指南">#</a></h1>
<blockquote>
<p>pprof 是一个用于可视化和分析分析数据的工具。</p>
</blockquote>
<h2 id="采样方式">采样方式<a hidden class="anchor" aria-hidden="true" href="#采样方式">#</a></h2>
<table>
<thead>
<tr>
<th style="text-align:left">方式名称</th>
<th style="text-align:left">如何使用</th>
<th style="text-align:left">优点</th>
<th style="text-align:left">缺点</th>
<th style="text-align:left">使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">runtime/pprof</td>
<td style="text-align:left">手动调用【runtime.StartCPUProfile、runtime.SweightCPUProfile】等<strong>API</strong>来进行数据的采集。采集程序（非 Server）的指定区块的运行数据进行分析。</td>
<td style="text-align:left"><strong>灵活性高</strong>、按需采集。</td>
<td style="text-align:left"></td>
<td style="text-align:left"><strong>工具型应用</strong>（比如说定制化的分析小工具、集成到公司监控系统）。这种应用运行一段时间就结束。</td>
</tr>
<tr>
<td style="text-align:left">net/http/pprof</td>
<td style="text-align:left">通过<strong>http</strong>服务来获取Profile采样文件。 <code>import _ &quot;net/http/pprof&quot;</code>。基于 HTTP Server 运行，并且可以采集运行时数据进行分析。<code>net/http/pprof中只是使用runtime/pprof包来进行封装了一下，并在http端口上暴露出来</code></td>
<td style="text-align:left"><strong>简单易用</strong></td>
<td style="text-align:left"></td>
<td style="text-align:left">在线服务（一直运行着的程序）</td>
</tr>
<tr>
<td style="text-align:left">go test</td>
<td style="text-align:left">通过命令<code>go test -bench . -cpuprofile cpu.prof</code>来进行采集数据。</td>
<td style="text-align:left"><strong>针对性强</strong>、细化到函数</td>
<td style="text-align:left"></td>
<td style="text-align:left">进行某函数的性能测试</td>
</tr>
</tbody>
</table>
<h2 id="指标解释">指标解释<a hidden class="anchor" aria-hidden="true" href="#指标解释">#</a></h2>
<p><img loading="lazy" src="https://github.com/user-attachments/assets/c2182bee-333f-4ec3-94cb-7a36440bb105" alt="image"  />
</p>
<p>常用指标如下：</p>
<ul>
<li>
<p>allocs：所有时刻的内存使用情况，包括正在使用的及已经回收的</p>
</li>
<li>
<p>block：导致在同步原语上发生阻塞的堆栈跟踪</p>
</li>
<li>
<p>cmdline： 当前程序的命令行的完整调用路径。</p>
</li>
<li>
<p>goroutine：目前的 goroutine 数量及运行情况</p>
</li>
<li>
<p>heap：当前时刻的内存使用情况</p>
</li>
<li>
<p>mutex：查看导致互斥锁的竞争持有者的堆栈跟踪</p>
</li>
<li>
<p>profile：默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件</p>
</li>
<li>
<p>threadcreate：查看创建新 OS 线程的堆栈跟踪。</p>
</li>
<li>
<p>trance：当前程序执行的追踪，可以在秒数的 GET 参数中指定持续时间。在获取追踪文件后，请使用 go 工具的 trace 命令来调查追踪。（<a href="https://mp.weixin.qq.com/s/I9xSMxy32cALSNQAN8wlnQ">深入浅出 Go trace (qq.com)</a>）</p>
</li>
</ul>
<blockquote>
<p>注意，默认情况下是不追踪block和mutex的信息的，如果想要看这两个信息，需要在代码中加上两行：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>runtime.<span style="color:#50fa7b">SetBlockProfileRate</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// 开启对阻塞操作的跟踪，block  
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>runtime.<span style="color:#50fa7b">SetMutexProfileFraction</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// 开启对锁调用的跟踪，mutex
</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>​	注意，上文的所有信息都是实时的，如果你刷新一下，是可以看到数字在变化的。此时如果点击蓝色的连接，可以看到一些协程的栈信息，这些信息并不容易阅读。如果想要更加清晰的数据，需要将信息保存下来，在本地进行分析。</p>
<h2 id="理解指标">理解指标<a hidden class="anchor" aria-hidden="true" href="#理解指标">#</a></h2>
<ul>
<li>flat：函数自身的运行耗时。</li>
<li>flat%：函数自身在 CPU 运行耗时总比例。</li>
<li>sum%：函数自身累积使用 CPU 总比例。</li>
<li>cum：函数自身及其调用函数的运行总耗时。</li>
<li>cum%：函数自身及其调用函数的运行耗时总比例。</li>
</ul>
<h3 id="flat-flat"><code>flat flat%</code><a hidden class="anchor" aria-hidden="true" href="#flat-flat">#</a></h3>
<p>​	一个函数内的 directly 操作的物理耗时。例如</p>
<blockquote>
<p>flat只会记录 step2 和 step3 的时间</p>
</blockquote>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">foo</span>(){
</span></span><span style="display:flex;"><span>     <span style="color:#50fa7b">a</span>()                                        <span style="color:#6272a4">// step1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>     largeArray <span style="color:#ff79c6">:=</span> [math.MaxInt64]<span style="color:#8be9fd">int64</span>{}       <span style="color:#6272a4">// step2
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>     <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; math.MaxInt64; i<span style="color:#ff79c6">++</span> {       <span style="color:#6272a4">// step3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>             <span style="color:#50fa7b">c</span>()                                <span style="color:#6272a4">// step4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>     }
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	flat%即是 <code>flat/总运行时间</code>。内存等参数同理。<strong>所有的 flat 相加即是总采样时间</strong>，所有的flat%相加应该等于100%。</p>
<p>​	flat一般是我们最关注的。其代表一个函数可能非常耗时，或者调用了非常多次，或者两者兼而有之，从而导致这个函数消耗了最多的时间。</p>
<p>​	如果是我们自己编写的代码，则很可能有一些无脑 for 循环、复杂的计算、字符串操作、频繁申请内存等等。</p>
<p>​	如果是第三方库的代码，则很可能我们过于频繁地调用了这些第三方库，或者以不正确的方式使用了这些第三方库。</p>
<h3 id="cum-cum"><code>cum cum%</code><a hidden class="anchor" aria-hidden="true" href="#cum-cum">#</a></h3>
<p>​	相比 flat，cum则是这个函数内所有操作的物理耗时，比如包括了上述的 step1、2、3、4。</p>
<p>​	cum%即是<code>cum的时间/总运行时间</code>。内存等参数同理。</p>
<p>​	一般cum是我们次关注的，且需要结合flat来看。</p>
<p><strong>flat 可以让我们知道哪个函数耗时多，而 cum 可以帮助我们找到是哪些函数调用了这些耗时的（flat 值大的）函数。</strong></p>
<h3 id="sum"><code>sum%</code><a hidden class="anchor" aria-hidden="true" href="#sum">#</a></h3>
<p>​	其上所有行的flat%的累加。可以视为，这一行及其以上行，其所有的 directly 操作一共占了多少物理时间。</p>
<h2 id="案例分析">案例分析<a hidden class="anchor" aria-hidden="true" href="#案例分析">#</a></h2>
<h2 id="go-test">go test<a hidden class="anchor" aria-hidden="true" href="#go-test">#</a></h2>
<ul>
<li>cpu 使用分析：<code>-cpuprofile=cpu.pprof</code></li>
<li>内存使用分析：<code>-benchmem -memprofile=mem.pprof</code></li>
<li>block分析：<code>-blockprofile=block.pprof</code></li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go <span style="color:#8be9fd;font-style:italic">test</span> -bench<span style="color:#ff79c6">=</span>. -run<span style="color:#ff79c6">=</span>none -benchmem -memprofile<span style="color:#ff79c6">=</span>mem.pprof 
</span></span><span style="display:flex;"><span>go <span style="color:#8be9fd;font-style:italic">test</span> -bench<span style="color:#ff79c6">=</span>. -run<span style="color:#ff79c6">=</span>none -blockprofile<span style="color:#ff79c6">=</span>block.pprof 
</span></span><span style="display:flex;"><span>go <span style="color:#8be9fd;font-style:italic">test</span> -bench<span style="color:#ff79c6">=</span>. -run<span style="color:#ff79c6">=</span>none -benchmem -memprofile<span style="color:#ff79c6">=</span>mem.pprof -cpuprofile<span style="color:#ff79c6">=</span>cpu.pprof s
</span></span><span style="display:flex;"><span>go <span style="color:#8be9fd;font-style:italic">test</span> -bench<span style="color:#ff79c6">=</span>. -run<span style="color:#ff79c6">=</span>none -benchmem -memprofile<span style="color:#ff79c6">=</span>mem.pprof -cpuprofsile<span style="color:#ff79c6">=</span>cpu.pprof -blockprofile<span style="color:#ff79c6">=</span>block.pprof
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="runtimepprof">runtime/pprof<a hidden class="anchor" aria-hidden="true" href="#runtimepprof">#</a></h2>
<p>除了注入 http handler 和 go test 以外，我们还可以在程序中通过 pprof 所提供的 Lookup 方法来进行相关内容的采集和调用，其一共支持六种类型，分别是：goroutine、threadcreate、heap、block、mutex，代码如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> LookupType <span style="color:#8be9fd">int8</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">const</span> ( 
</span></span><span style="display:flex;"><span>    LookupGoroutine LookupType = <span style="color:#ff79c6">iota</span> 
</span></span><span style="display:flex;"><span>    LookupThreadcreate LookupHeap 
</span></span><span style="display:flex;"><span>    LookupAllocs LookupBlock LookupMutex ) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">pprofLookup</span>(lookupType LookupType, w io.Writer) <span style="color:#8be9fd">error</span> { 
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> err <span style="color:#8be9fd">error</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">switch</span> lookupType { 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> LookupGoroutine: 
</span></span><span style="display:flex;"><span>        	p <span style="color:#ff79c6">:=</span> pprof.<span style="color:#50fa7b">Lookup</span>(<span style="color:#f1fa8c">&#34;goroutine&#34;</span>) 
</span></span><span style="display:flex;"><span>        err = p.<span style="color:#50fa7b">WriteTo</span>(w, <span style="color:#bd93f9">2</span>) 
</span></span><span style="display:flex;"><span>    	<span style="color:#ff79c6">case</span> LookupThreadcreate: 
</span></span><span style="display:flex;"><span>        	p <span style="color:#ff79c6">:=</span> pprof.<span style="color:#50fa7b">Lookup</span>(<span style="color:#f1fa8c">&#34;threadcreate&#34;</span>) 
</span></span><span style="display:flex;"><span>        err = p.<span style="color:#50fa7b">WriteTo</span>(w, <span style="color:#bd93f9">2</span>) 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> LookupHeap: 
</span></span><span style="display:flex;"><span>        	p <span style="color:#ff79c6">:=</span> pprof.<span style="color:#50fa7b">Lookup</span>(<span style="color:#f1fa8c">&#34;heap&#34;</span>) 
</span></span><span style="display:flex;"><span>        err = p.<span style="color:#50fa7b">WriteTo</span>(w, <span style="color:#bd93f9">2</span>) 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> LookupAllocs: 
</span></span><span style="display:flex;"><span>        	p <span style="color:#ff79c6">:=</span> pprof.<span style="color:#50fa7b">Lookup</span>(<span style="color:#f1fa8c">&#34;allocs&#34;</span>) 
</span></span><span style="display:flex;"><span>        	err = p.<span style="color:#50fa7b">WriteTo</span>(w, <span style="color:#bd93f9">2</span>) 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> LookupBlock: 
</span></span><span style="display:flex;"><span>        	p <span style="color:#ff79c6">:=</span> pprof.<span style="color:#50fa7b">Lookup</span>(<span style="color:#f1fa8c">&#34;block&#34;</span>) 
</span></span><span style="display:flex;"><span>        	err = p.<span style="color:#50fa7b">WriteTo</span>(w, <span style="color:#bd93f9">2</span>) 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> LookupMutex: 
</span></span><span style="display:flex;"><span>        	p <span style="color:#ff79c6">:=</span> pprof.<span style="color:#50fa7b">Lookup</span>(<span style="color:#f1fa8c">&#34;mutex&#34;</span>) 
</span></span><span style="display:flex;"><span>        	err = p.<span style="color:#50fa7b">WriteTo</span>(w, <span style="color:#bd93f9">2</span>) 
</span></span><span style="display:flex;"><span>    	} 
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	接下来我们只需要对该方法进行调用就好了，其提供了 <code>io.Writer</code> 接口，也就是只要实现了对应的 Write 方法，我们可以将其写到任何支持地方去，如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">init</span>() { 
</span></span><span style="display:flex;"><span>    runtime.<span style="color:#50fa7b">SetMutexProfileFraction</span>(<span style="color:#bd93f9">1</span>) 
</span></span><span style="display:flex;"><span>    runtime.<span style="color:#50fa7b">SetBlockProfileRate</span>(<span style="color:#bd93f9">1</span>) 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() { 
</span></span><span style="display:flex;"><span>    http.<span style="color:#50fa7b">HandleFunc</span>(<span style="color:#f1fa8c">&#34;/lookup/heap&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
</span></span><span style="display:flex;"><span>        _ = <span style="color:#50fa7b">pprofLookup</span>(LookupHeap, os.Stdout) }) 
</span></span><span style="display:flex;"><span>    http.<span style="color:#50fa7b">HandleFunc</span>(<span style="color:#f1fa8c">&#34;/lookup/threadcreate&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) { 
</span></span><span style="display:flex;"><span>        _ = <span style="color:#50fa7b">pprofLookup</span>(LookupThreadcreate, os.Stdout) }) 
</span></span><span style="display:flex;"><span>    http.<span style="color:#50fa7b">HandleFunc</span>(<span style="color:#f1fa8c">&#34;/lookup/block&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) { 
</span></span><span style="display:flex;"><span>        _ = <span style="color:#50fa7b">pprofLookup</span>(LookupBlock, os.Stdout) }) 
</span></span><span style="display:flex;"><span>    http.<span style="color:#50fa7b">HandleFunc</span>(<span style="color:#f1fa8c">&#34;/lookup/goroutine&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) { 
</span></span><span style="display:flex;"><span>        _ = <span style="color:#50fa7b">pprofLookup</span>(LookupGoroutine, os.Stdout) }) 
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    _ = http.<span style="color:#50fa7b">ListenAndServe</span>(<span style="color:#f1fa8c">&#34;0.0.0.0:6060&#34;</span>, <span style="color:#ff79c6">nil</span>) 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="采集cpucpu-占用过高">采集CPU(CPU 占用过高)<a hidden class="anchor" aria-hidden="true" href="#采集cpucpu-占用过高">#</a></h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CollectCpu</span>() { 
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// 创建分析文件，在当前目录下 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	file, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Create</span>(<span style="color:#f1fa8c">&#34;./cpu.prof&#34;</span>) 
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> { 
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;创建采集文件失败, err:%v\n&#34;</span>, err) 
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> 
</span></span><span style="display:flex;"><span>	} 
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// 进行 cpu 数据的获取 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pprof.<span style="color:#50fa7b">StartCPUProfile</span>(file) 
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">defer</span> pprof.<span style="color:#50fa7b">SweightCPUProfile</span>() 
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// 执行一段有问题的代码 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#bd93f9">4</span>; i<span style="color:#ff79c6">++</span> { s
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">do1</span>() 
</span></span><span style="display:flex;"><span>	} 
</span></span><span style="display:flex;"><span>	time.<span style="color:#50fa7b">Sleep</span>(<span style="color:#bd93f9">10</span> <span style="color:#ff79c6">*</span> time.Second) 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="nethttppprof">net/http/pprof<a hidden class="anchor" aria-hidden="true" href="#nethttppprof">#</a></h2>
<pre tabindex="0"><code> # 网页，运行该命令让程序开始半分钟（默认值）的CPU采样 服务开启了 pprof
 $ go tool pprof http://127.0.0.1:8080/debug/pprof/profile
</code></pre><p><img loading="lazy" src="https://github.com/user-attachments/assets/d56c6bdc-d272-4960-8ac0-943f42b46e54" alt="image"  />
</p>
<h3 id="扩展参数选项">扩展参数选项<a hidden class="anchor" aria-hidden="true" href="#扩展参数选项">#</a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">选项名</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">alloc_objects</td>
<td style="text-align:left">分析应用程序的内存临时分配情况</td>
</tr>
<tr>
<td style="text-align:left">alloc_space</td>
<td style="text-align:left">查看每个函数分配的内存空间大小</td>
</tr>
<tr>
<td style="text-align:left">inuse_space</td>
<td style="text-align:left">分析应用程序的常驻内存占用情况</td>
</tr>
<tr>
<td style="text-align:left">inuse_objects</td>
<td style="text-align:left">查看每个函数所分配的对象数量</td>
</tr>
</tbody>
</table>
<h3 id="常用命令">常用命令<a hidden class="anchor" aria-hidden="true" href="#常用命令">#</a></h3>
<h4 id="web-连线图">web （连线图）<a hidden class="anchor" aria-hidden="true" href="#web-连线图">#</a></h4>
<blockquote>
<p>通过Web浏览器可视化图</p>
</blockquote>
<blockquote>
<p><code>web</code> 将会生成一张svg格式的图片，并用默认打开程序打开（一般是浏览器）。渲染图片需要下载 <a href="https://graphviz.org/download/">Download | Graphviz</a></p>
</blockquote>
<p><img loading="lazy" src="https://github.com/user-attachments/assets/f919098b-a923-4cbd-8349-89f0e3a0d52b" alt="image"  />
</p>
<p>​	节点的颜色越红，其cum和cum%越大。其颜色越灰白，则cum和cum%越小。</p>
<p>​	节点越大，其flat和flat%越大；其越小，则flat和flat%越小</p>
<p>​	线条代表了函数的调用链，线条越粗，代表指向的函数消耗了越多的资源。反之亦然。</p>
<p>​	线条的样式代表了调用关系。实线代表直接调用；虚线代表中间少了几个节点；带有inline字段表示该函数被内联进了调用方（不用在意，可以理解成实线）。</p>
<blockquote>
<p>对于一些代码行比较少的函数，编译器倾向于将它们在编译期展开从而消除函数调用，这种行为就是内联。</p>
</blockquote>
<h4 id="weight">weight<a hidden class="anchor" aria-hidden="true" href="#weight">#</a></h4>
<blockquote>
<p><code>weight</code>默认按flat排序，打印出消耗前10的函数。也可以选择消耗前N的函数，比如<code>weight5</code>，<code>weight20</code>。</p>
</blockquote>
<p><img loading="lazy" src="https://github.com/user-attachments/assets/a1c83317-3d82-4bfe-aaf7-4abfebd1884f" alt="image"  />
</p>
<h4 id="list">list<a hidden class="anchor" aria-hidden="true" href="#list">#</a></h4>
<blockquote>
<p>当发现某个函数资源占用情况可疑时，可以通过 <code>list 函数名</code> 定位到具体的代码位置。比如:<code> list Fire</code></p>
</blockquote>
<p><img loading="lazy" src="https://github.com/user-attachments/assets/87007000-e59a-43d1-bcce-2c8e5fe79a9c" alt="image"  />
</p>
<h3 id="火焰图">火焰图<a hidden class="anchor" aria-hidden="true" href="#火焰图">#</a></h3>
<p>​	调用顺序<strong>由上到下</strong>，每一块代表一个函数，越大代表占用 CPU 的时间更长。同时它也可以支持点击块深入进行分析。</p>
<p><img loading="lazy" src="https://github.com/user-attachments/assets/4992c35f-ac6f-4e44-8246-a99ce6302bfb" alt="image"  />
</p>
<h2 id="代码优化建议">代码优化建议<a hidden class="anchor" aria-hidden="true" href="#代码优化建议">#</a></h2>
<p>以下是一些从其它项目借鉴或者自己总结的实践经验，它们只是建议，而不是准则，实际项目中应该以性能分析数据来作为优化的参考，<strong>避免过早优化</strong>。</p>
<ol>
<li>对频繁分配的小对象，使用 <a href="https://golang.org/pkg/sync/#Pool">sync.Pool</a> 对象池避免分配</li>
<li>自动化的 DeepCopy 是非常耗时的，其中涉及到反射，内存分配，容器(如 map)扩展等，大概比手动拷贝慢一个数量级</li>
<li>用 atomic.Load/StoreXXX，atomic.Value, sync.Map 等代替 Mutex。(优先级递减)</li>
<li>使用高效的第三方库，如用<a href="https://github.com/valyala/fasthttp">fasthttp</a>替代 net/http</li>
<li>在开发环境加上<code>-race</code>编译选项进行竞态检查</li>
<li>在开发环境开启 net/http/pprof，方便实时 pprof</li>
<li>将所有外部IO(网络IO，磁盘IO)做成异步ss</li>
</ol>
<h2 id="参考文章">参考文章<a hidden class="anchor" aria-hidden="true" href="#参考文章">#</a></h2>
<ul>
<li><a href="https://wxsm.space/2023/go-pprof-note/">Go 语言性能调试与分析工具：pprof 用法简介 | wxsm&rsquo;s pace</a></li>
<li><a href="https://juejin.cn/post/7122473470424219656">golang pprof实用使用指南 - 掘金 (juejin.cn)</a></li>
<li><a href="https://nyadgar.com/posts/go-profiling-like-a-pro/">Profiling in Go: A Practical Guide | nyadgar.com</a></li>
<li><a href="https://debug-lixiwen.github.io/2021/07/18/shi-zhan/">golang的pprof与火焰图实战 | wish (debug-lixiwen.github.io)</a></li>
<li><a href="https://blog.wolfogre.com/posts/go-ppof-practice/">golang pprof 实战 | Wolfogre&rsquo;s Blog</a></li>
<li><a href="https://farmerchillax.github.io/2023/07/04/Go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/">Go性能分析工具 | Farmer (farmerchillax.github.io)</a></li>
</ul>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/golang/">Golang</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Luenci</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
