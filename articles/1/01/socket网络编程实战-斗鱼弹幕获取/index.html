<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>socket网络编程实战-斗鱼弹幕获取 | Luenci</title>
<meta name="keywords" content="网络编程">
<meta name="description" content="asyncore模块
介绍

这个模块为异步socket的服务器客户端通信提供简单的接口。
该模块提供了异步socket服务客户端和服务器的基础架构。
相比python原生的socket api，asyncore具备有很大的优势，asyncore对原生的socket进行封装，提供非常简洁优秀的接口，利用asyncore覆写相关需要处理的接口方法，就可以完成一个socket的网络编程，从而需要处理复杂的socket网络状况以及多线程处理等等。

实现流程


客户端 Socket 开发基本使用
1.定义类继承自asyncore.dispatcher
2.实现类中的回调代码


实现构造函数

调用父类方法
创建 Socket对象
连接服务器



实现handle_connect回调函数

当socket连接服务器成功时回调该函数



实现writable回调函数

描述是否有数据需要被发送到服务器。返回值为True表示可写，False表示不可写，如果不实现默认返回为True，当返回True时，回调函数handle_write将被触发



实现handle_write 回调函数

当有数据需要发送时（writable回调函数返回True时），该函数被触发，通常情况下在该函数中编写send方法发送数据



实现readable回调函数

描述是否有数据从服务端读取。返回True 表示有数据需要读取，False表示没有数据需要被读取，当不实现默认返回为True，当返回True 时，回调函数handle_read将被触发



实现handle_read 回调函数

当有数据需要读取时触发（readable回调函数返回True
时），该函数被触发，通常情况下在该函数中编写recv方法接收数据



实现handle_error回调函数

当程序运行过程发生异常时回调



实现handle_close回调函数

当连接被关闭时触发



3.创建对象并且执行asyncore.loop进入运行循环

timeout表示一次循环所需要的时长





 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64


import asyncore
import sys


# 定义类继承自 asyncore.dispather
class scoket_client(asyncore.dispatcher):

    # 实现类中的回调代码
    def __init__(self, host, port):
        # 调用父类的方法
        asyncore.dispatcher.__init__(self)

        # 创建 Scoket 服务器
        self.create_socket()

        # 连接地址
        address = (host, port)
        self.connect(address)
        pass

    # 实现handle_connect回调函数
    def handle_connect(self):
        print(&#34;连接成功&#34;)

    # 实现writable函数
    def writable(self):
        return False

    # 实现handle_write回调函数
    def handle_write(self):
        # 内部实现对服务器发送数据代码
        # 调用 send 方法发送数据，参数是字节数据
        self.send(&#34;hello world&#34;.encode(&#39;utf-8&#39;))
        # self.send(&#34;hello world&#34;)

    # 实现readable回调函数
    def readable(self):
        return True

    # 实现handle_read回调函数
    def handle_read(self):
        # 主动接收数据
        result = self.recv(1024)
        print(result)

    # 实现handle_error回调函数
    def handle_error(self):
        # 编写处理错误方法
        t, e, trace = sys.exc_info()

    # 实现handle_close回调函数
    def handle_close(self):
        print(&#34;连接关闭&#34;)
        self.close()


# 创建对象并且执行asyncore.loop 进入循环


if __name__ == &#39;__main__&#39;:
    client = scoket_client(&#39;127.0.0.1&#39;, 9000)

    # 开始启动运行循环
    asyncore.loop(timeout=5)


">
<meta name="author" content="Luenci">
<link rel="canonical" href="http://localhost:1313/articles/1/01/socket%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98-%E6%96%97%E9%B1%BC%E5%BC%B9%E5%B9%95%E8%8E%B7%E5%8F%96/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.54405a410796490bc874ab6181fac9b675753cc2b91375d8f882566459eca428.css" integrity="sha256-VEBaQQeWSQvIdKthgfrJtnV1PMK5E3XY&#43;IJWZFnspCg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/articles/1/01/socket%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98-%E6%96%97%E9%B1%BC%E5%BC%B9%E5%B9%95%E8%8E%B7%E5%8F%96/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Luenci (Alt + H)">Luenci</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/index.xml" title="RSS Feed">
                    <span>RSS Feed</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      socket网络编程实战-斗鱼弹幕获取
    </h1>
    <div class="post-meta">Luenci

</div>
  </header> 
  <div class="post-content"><h1 id="asyncore模块">asyncore模块<a hidden class="anchor" aria-hidden="true" href="#asyncore模块">#</a></h1>
<h2 id="介绍">介绍<a hidden class="anchor" aria-hidden="true" href="#介绍">#</a></h2>
<blockquote>
<p>这个模块为异步socket的服务器客户端通信提供简单的接口。</p>
<p>该模块提供了异步socket服务客户端和服务器的基础架构。</p>
<p>相比python原生的socket api，asyncore具备有很大的优势，asyncore对原生的socket进行封装，提供非常简洁优秀的接口，利用asyncore覆写相关需要处理的接口方法，就可以完成一个socket的网络编程，从而需要处理复杂的socket网络状况以及多线程处理等等。</p>
</blockquote>
<h2 id="实现流程">实现流程<a hidden class="anchor" aria-hidden="true" href="#实现流程">#</a></h2>
<p><img loading="lazy" src="https://i.postimg.cc/VvCFY8Qg/image-20191029171333100.png" alt="image-asynocre"  />
</p>
<h1 id="客户端-socket-开发基本使用">客户端 Socket 开发基本使用<a hidden class="anchor" aria-hidden="true" href="#客户端-socket-开发基本使用">#</a></h1>
<p>1.定义类继承自<code>asyncore.dispatcher</code></p>
<p>2.实现类中的回调代码</p>
<ul>
<li>
<p>实现构造函数</p>
<ul>
<li>调用父类方法</li>
<li>创建 <code>Socket</code>对象</li>
<li>连接服务器</li>
</ul>
</li>
<li>
<p>实现<code>handle_connect</code>回调函数</p>
<blockquote>
<p>当<code>socket</code>连接服务器成功时回调该函数</p>
</blockquote>
</li>
<li>
<p>实现<code>writable</code>回调函数</p>
<blockquote>
<p>描述是否有数据需要被发送到服务器。返回值为<code>True</code>表示可写，<code>False</code>表示不可写，如果不实现默认返回为<code>True</code>，当返回<code>True</code>时，回调函数<code>handle_write</code>将被触发</p>
</blockquote>
</li>
<li>
<p>实现<code>handle_write</code> 回调函数</p>
<blockquote>
<p>当有数据需要发送时（<code>writable</code>回调函数返回<code>True</code>时），该函数被触发，通常情况下在该函数中编写<code>send</code>方法发送数据</p>
</blockquote>
</li>
<li>
<p>实现<code>readable</code>回调函数</p>
<blockquote>
<p>描述是否有数据从服务端读取。返回<code>True</code> 表示有数据需要读取，<code>False</code>表示没有数据需要被读取，当不实现默认返回为<code>True</code>，当返回<code>True</code> 时，回调函数<code>handle_read</code>将被触发</p>
</blockquote>
</li>
<li>
<p>实现<code>handle_read </code>回调函数</p>
<blockquote>
<p>当有数据需要读取时触发（<code>readable</code>回调函数返回<code>True</code>
时），该函数被触发，通常情况下在该函数中编写<code>recv</code>方法接收数据</p>
</blockquote>
</li>
<li>
<p>实现<code>handle_error</code>回调函数</p>
<blockquote>
<p>当程序运行过程发生异常时回调</p>
</blockquote>
</li>
<li>
<p>实现<code>handle_close</code>回调函数</p>
<blockquote>
<p>当连接被关闭时触发</p>
</blockquote>
</li>
<li>
<p>3.创建对象并且执行<code>asyncore.loop</code>进入运行循环</p>
<ul>
<li><code>timeout</code>表示一次循环所需要的时长</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> asyncore
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 定义类继承自 asyncore.dispather</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">scoket_client</span>(asyncore<span style="color:#ff79c6">.</span>dispatcher):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 实现类中的回调代码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> __init__(self, host, port):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 调用父类的方法</span>
</span></span><span style="display:flex;"><span>        asyncore<span style="color:#ff79c6">.</span>dispatcher<span style="color:#ff79c6">.</span>__init__(self)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 创建 Scoket 服务器</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>create_socket()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 连接地址</span>
</span></span><span style="display:flex;"><span>        address <span style="color:#ff79c6">=</span> (host, port)
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>connect(address)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 实现handle_connect回调函数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">handle_connect</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;连接成功&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 实现writable函数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">writable</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 实现handle_write回调函数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">handle_write</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 内部实现对服务器发送数据代码</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 调用 send 方法发送数据，参数是字节数据</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>send(<span style="color:#f1fa8c">&#34;hello world&#34;</span><span style="color:#ff79c6">.</span>encode(<span style="color:#f1fa8c">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># self.send(&#34;hello world&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 实现readable回调函数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">readable</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 实现handle_read回调函数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">handle_read</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 主动接收数据</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">1024</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(result)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 实现handle_error回调函数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">handle_error</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 编写处理错误方法</span>
</span></span><span style="display:flex;"><span>        t, e, trace <span style="color:#ff79c6">=</span> sys<span style="color:#ff79c6">.</span>exc_info()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 实现handle_close回调函数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">handle_close</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;连接关闭&#34;</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 创建对象并且执行asyncore.loop 进入循环</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    client <span style="color:#ff79c6">=</span> scoket_client(<span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>, <span style="color:#bd93f9">9000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 开始启动运行循环</span>
</span></span><span style="display:flex;"><span>    asyncore<span style="color:#ff79c6">.</span>loop(timeout<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="斗鱼弹幕实战">斗鱼弹幕实战<a hidden class="anchor" aria-hidden="true" href="#斗鱼弹幕实战">#</a></h1>
<ul>
<li>
<p>文档资料</p>
<ul>
<li>斗鱼弹幕服务器第三方接入协议V1.6.2.pdf 官方提供协议文档弹幕</li>
</ul>
</li>
</ul>
<h2 id="客户端开发流程">客户端开发流程<a hidden class="anchor" aria-hidden="true" href="#客户端开发流程">#</a></h2>
<ul>
<li>
<p>连接初始化</p>
<ul>
<li>使用TCP连接服务器
<ul>
<li>IP地址：openbarrage.douyutv.com</li>
<li>端口：8601</li>
</ul>
</li>
<li>客户端向弹幕服务器发送登录请弧，登录弹幕服务器</li>
<li>弹幕服务器收到客户端登录请求并完成登录后，返回登录成功消息给客户端</li>
<li>客户端收到登录成功消息后发送进入弹幕分组请求给弹幕服务器</li>
<li>弹幕服务器接受到客户端弹幕分组请求后将客户端添加到请求指定的弹幕分组中</li>
</ul>
</li>
<li>
<p>服务过程</p>
<ul>
<li>客户端每隔45秒发送心跳给弹幕服务器，弹幕服务器回复心跳信息给客户端</li>
<li>弹幕服务器如有广播信息，则推送给客户端，服务器消息协议</li>
</ul>
</li>
<li>
<p>断开连接</p>
<ul>
<li>客户端发送登出消息</li>
<li>客户端关闭TCP连接</li>
</ul>
</li>
</ul>
<h2 id="数据发送和接收流程">数据发送和接收流程<a hidden class="anchor" aria-hidden="true" href="#数据发送和接收流程">#</a></h2>
<p><img loading="lazy" src="https://i.postimg.cc/qMp1Qkm8/image-20191030102511977.png" alt="image-数据发送和接收流程"  />
</p>
<h3 id="数据包讲解">数据包讲解<a hidden class="anchor" aria-hidden="true" href="#数据包讲解">#</a></h3>
<p><img loading="lazy" src="https://i.postimg.cc/4dShcQFL/image-20191030103731258.png" alt="image-20191030103731258"  />
</p>
<ul>
<li>消息长度：4 字节小端整数，表示整条消息（包括自身）长度（字节数）消息长度出现两遍，二者相同</li>
<li>消息类型：2 字节小端整数，表示消息类型。</li>
<li>取值如下：
<ul>
<li>689 客户端发送给弹幕服务器的文本格式数据</li>
<li>690 弹幕服务器发送给客户端的文本格式数据。</li>
</ul>
</li>
<li>加密字段：暂时未用，默认为 0。</li>
<li>保留字段：暂时未用，默认为 0。</li>
<li>数据部分：斗鱼独创序列化文本数据，结尾必须为‘\0’。</li>
<li>详细序列化、反序列化算法见下节。（所有协议内容均为 UTF-8 编码）</li>
</ul>
<h3 id="数据包的封装">数据包的封装<a hidden class="anchor" aria-hidden="true" href="#数据包的封装">#</a></h3>
<blockquote>
<p>对数据包进行对象化封装，对数据的封装方便以后使用，实现对象和二进制数据之间的转换</p>
</blockquote>
<ul>
<li>通过参数构建数据包对象</li>
<li>实现获取数据包长度的方法</li>
<li>实现获取二进制数据的方法</li>
</ul>
<h2 id="实现发送数据包">实现发送数据包<a hidden class="anchor" aria-hidden="true" href="#实现发送数据包">#</a></h2>
<p><img loading="lazy" src="https://i.postimg.cc/NGH0BBG3/image-20191030165625836.png" alt="image-20191030165625836"  />
</p>
<ul>
<li>构建发送数据包的容器</li>
<li>实现回调函数，判断容器中有数据就发送没有数据不发送</li>
<li>实现登录函数
<ul>
<li>构建登录数据包</li>
<li>把数据包添加到发送数据包容器中</li>
</ul>
</li>
</ul>
<h2 id="实现接收数据">实现接收数据<a hidden class="anchor" aria-hidden="true" href="#实现接收数据">#</a></h2>
<p><img loading="lazy" src="https://i.postimg.cc/mkDvTKnp/image-20191030174404676.png" alt="image-20191030174404676"  />
</p>
<ul>
<li>构建接收数据包队列</li>
<li>读取回调函数中读取数据
<ul>
<li>读取长度</li>
<li>读取内容</li>
<li>构建数据包对象</li>
<li>把数据包放入接收数据包容器中</li>
</ul>
</li>
<li>构建处理数据包线程
<ul>
<li>构建线程</li>
<li>实现回调函数处理数据</li>
</ul>
</li>
</ul>
<h2 id="实现外部传入回调函散">实现外部传入回调函散<a hidden class="anchor" aria-hidden="true" href="#实现外部传入回调函散">#</a></h2>
<blockquote>
<p>通过外部指定回调函数实现自定义数据处理</p>
</blockquote>
<ul>
<li>添加参数<code>callback</code>
<ul>
<li>构造函数中添加参数</li>
<li>外部传入自定义回调函数</li>
</ul>
</li>
<li>在处理接收数据包的线程中调用回调函数</li>
</ul>
<h2 id="数据内容序列话与反序列化">数据内容序列话与反序列化<a hidden class="anchor" aria-hidden="true" href="#数据内容序列话与反序列化">#</a></h2>
<ul>
<li>1 键 key 和值 value 直接采用‘@=’分割</li>
<li>2 数组采用‘/’分割</li>
<li>3 如果 key 或者 value 中含有字符‘/’，则使用‘@S’转义</li>
<li>4 如果 key 或者 value 中含有字符‘@’ ，使用‘@A’转义
举例：
<ul>
<li>多个键值对数据：key1@=value1/key2@=value2/key3@=value3/</li>
<li>数组数据：value1/value2/value3/</li>
</ul>
</li>
<li>不同消息有相同的协议头、序列化方式</li>
</ul>
<h2 id="加入弹幕分组">加入弹幕分组<a hidden class="anchor" aria-hidden="true" href="#加入弹幕分组">#</a></h2>
<blockquote>
<p>​        第三方平台建议选择-9999（即海量弹幕模式  )</p>
</blockquote>
<h2 id="心跳机制">心跳机制<a hidden class="anchor" aria-hidden="true" href="#心跳机制">#</a></h2>
<blockquote>
<p>作用是让服务器解决假死连接问题，客户端必须每隔45秒发送一次请求，否则就会被主动断开。</p>
</blockquote>
<ul>
<li>实现发送心跳函数
<ul>
<li>构建心跳数据包</li>
<li>把数据包添加到发送数据包容器队列中</li>
</ul>
</li>
<li>构建心跳线程
<ul>
<li>构建心跳线程</li>
<li>添加触发机制</li>
<li>添加暂停机制</li>
</ul>
</li>
</ul>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Luenci</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
