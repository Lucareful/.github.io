<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>基于Python语言的IP代理池 | Luenci</title>
<meta name="keywords" content="爬虫实践">
<meta name="description" content="环境：python3.6
MongoDB
flask
requests等第三方库
完整代码见： https://github.com/Lucareful/IPProxyPool
代理池概述
什么是代理池

代理池就是有代理IP组成的池子，它可以提供多个稳定可用的代理IP

为什么要实现代理池
我们在做爬虫的时候，最常见的一种反爬虫手段就是：IP反爬；也就是当同一个IP访问这个网站的次数过多，频率过高，就会限制这个IP的访问。就是需要经常换IP；

使用IP代理池是其中一个比较常用的方案
免费代理都是非常不稳定的，有10%是可用就很不错了
一些收费代理稳定性也不好

目的：从一堆不稳定的代理IP中，抽取高可用代理IP，给爬虫使用
代理池开发环境


python3开发语言


requests：发送请求，获取页面数据


lxml：使用XPATH从页面提取我们想要的书籍


pymonge：把提取到代理IP存储到MongoDB数据库中和MongoDB数据库中读取代理IP，给爬虫使用


Flask：用于提供WEB服务


代理池工作流程


1.代理池工作渡程描述：

代理IP采集模块-&gt;采集代理IP-&gt;检测代理IP-&gt;如果不可用用，直接过滤掉，如果可用，指定默认分数-&gt;存入数据库中
代理IP检测模块-&gt;从数据库中获取所有代理IP-&gt;检测代理IP-&gt;如果代理IP不可用用，就把分数-1，如果分数为0从数据库中删除，否则更新数据库，如果代理IP可用，恢复为默认分值，更新数据库
代理API模块-&gt;从数据库中高可用的代理IP给爬虫使用；
">
<meta name="author" content="Luenci">
<link rel="canonical" href="http://localhost:1313/articles/1/01/%E5%9F%BA%E4%BA%8Epython%E8%AF%AD%E8%A8%80%E7%9A%84ip%E4%BB%A3%E7%90%86%E6%B1%A0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.54405a410796490bc874ab6181fac9b675753cc2b91375d8f882566459eca428.css" integrity="sha256-VEBaQQeWSQvIdKthgfrJtnV1PMK5E3XY&#43;IJWZFnspCg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/articles/1/01/%E5%9F%BA%E4%BA%8Epython%E8%AF%AD%E8%A8%80%E7%9A%84ip%E4%BB%A3%E7%90%86%E6%B1%A0/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Luenci (Alt + H)">Luenci</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/index.xml" title="RSS Feed">
                    <span>RSS Feed</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      基于Python语言的IP代理池
    </h1>
    <div class="post-meta">Luenci

</div>
  </header> 
  <div class="post-content"><p>环境：python3.6</p>
<p>MongoDB</p>
<p>flask</p>
<p>requests等第三方库</p>
<p>完整代码见： <a href="https://github.com/Lucareful/IPProxyPool">https://github.com/Lucareful/IPProxyPool</a></p>
<h1 id="代理池概述">代理池概述<a hidden class="anchor" aria-hidden="true" href="#代理池概述">#</a></h1>
<h2 id="什么是代理池">什么是代理池<a hidden class="anchor" aria-hidden="true" href="#什么是代理池">#</a></h2>
<ul>
<li>代理池就是有代理IP组成的池子，它可以提供多个稳定可用的代理IP</li>
</ul>
<h2 id="为什么要实现代理池">为什么要实现代理池<a hidden class="anchor" aria-hidden="true" href="#为什么要实现代理池">#</a></h2>
<p>我们在做爬虫的时候，最常见的一种反爬虫手段就是：IP反爬；也就是当同一个IP访问这个网站的次数过多，频率过高，就会限制这个IP的访问。就是需要经常换IP；</p>
<ul>
<li>使用IP代理池是其中一个比较常用的方案</li>
<li>免费代理都是非常不稳定的，有10%是可用就很不错了</li>
<li>一些收费代理稳定性也不好</li>
</ul>
<p>目的：从一堆不稳定的代理IP中，抽取高可用代理IP，给爬虫使用</p>
<h1 id="代理池开发环境">代理池开发环境<a hidden class="anchor" aria-hidden="true" href="#代理池开发环境">#</a></h1>
<ul>
<li>
<p>python3开发语言</p>
</li>
<li>
<p>requests：发送请求，获取页面数据</p>
</li>
<li>
<p>lxml：使用XPATH从页面提取我们想要的书籍</p>
</li>
<li>
<p>pymonge：把提取到代理IP存储到MongoDB数据库中和MongoDB数据库中读取代理IP，给爬虫使用</p>
</li>
<li>
<p>Flask：用于提供WEB服务</p>
</li>
</ul>
<h1 id="代理池工作流程">代理池工作流程<a hidden class="anchor" aria-hidden="true" href="#代理池工作流程">#</a></h1>
<p><img loading="lazy" src="https://i.ibb.co/b7YyrM5/image-20191024195902163.png" alt="image-20191024195902163"  />
</p>
<p>1.代理池工作渡程描述：</p>
<ul>
<li>代理IP采集模块-&gt;采集代理IP-&gt;检测代理IP-&gt;如果不可用用，直接过滤掉，如果可用，指定默认分数-&gt;存入数据库中</li>
<li>代理IP检测模块-&gt;从数据库中获取所有代理IP-&gt;检测代理IP-&gt;如果代理IP不可用用，就把分数-1，如果分数为0从数据库中删除，否则更新数据库，如果代理IP可用，恢复为默认分值，更新数据库</li>
<li>代理API模块-&gt;从数据库中高可用的代理IP给爬虫使用；</li>
</ul>
<h2 id="代理池的模块及其作用">代理池的模块及其作用<a hidden class="anchor" aria-hidden="true" href="#代理池的模块及其作用">#</a></h2>
<p>五大核心模块</p>
<ul>
<li>爬虫模块
<ul>
<li>从代理IP网站上采集代理IP</li>
<li>进行校验（获取代理响应速度，协议类型，匿名类型）</li>
<li>把可用代理IP存储到数据库中</li>
<li></li>
</ul>
</li>
<li>代理IP的校验模块：获取指定代理的响应速度，支持的协议以及匿名程度
<ul>
<li>原因：网站上所标注的响应速度，协议类型和匿名类型是不准确的</li>
<li>这里使用<strong>httpbin.org</strong>进行检测</li>
</ul>
</li>
<li>数据库模块：实现对代理IP的增删改查操作
<ul>
<li>这里使用MongoDB来存储代理IP</li>
</ul>
</li>
<li>检测模块：定时的对代理池中代理进行检测，保证代理池中代理的可用性.
<ul>
<li>从数据库读取所有的代理IP</li>
<li>对代理IP进行逐一检测，可用开启多个协程，以提高检测速度</li>
<li>如果该代理不可用，就让这个代理分数-1，当代理的分数到0了，就删除该代理；如果检测到代理可用就恢复为满分.</li>
</ul>
</li>
<li>代理IP服务接口：提供高可用的代理IP给爬虫使用
<ul>
<li>根据协议类型和域名获取随机一个高质量代理IP</li>
<li>根据协议类型和域名获取多个高质量代理IP</li>
<li>根据代理IP不可用域名，告诉代理池这个代理IP在该域名下不可用，下次获取这个域名的代理IP时候，就不会再获取这个代理IP了，从而保证代理IP高可用性.</li>
</ul>
</li>
</ul>
<p>代理池的其它模块</p>
<ul>
<li>数据模型：domain.py
<ul>
<li>代理IP的数据模型，用于封装代理IP相关信息，比如ip，端口号，响应速度，协议类型，匿名类型，分数等</li>
</ul>
</li>
<li>程序启动入口：main.py·代理池提供一个统一的启动入口</li>
<li>工具模块：、</li>
<li>日志模块：用于记录日志信息</li>
<li>http模块：用于获取随机User-Agent的请求头</li>
<li>配置文件：settings.py
<ul>
<li>用于默认代理的分数，配置日志格式，文件，启动的爬虫，检验的间隔时间等.</li>
</ul>
</li>
</ul>
<h1 id="代理池的项目结构">代理池的项目结构<a hidden class="anchor" aria-hidden="true" href="#代理池的项目结构">#</a></h1>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">--</span>IPProxyPoo1
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">--</span>core
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">--</span>db
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">--</span>__init__<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">--</span>mongo_pool<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">--</span>proxy_validate
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">--</span>__init__<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">--</span>httpbin_validator<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">--</span>proxy_spider
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">--</span>__init__<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">--</span>base_spider<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">--</span>proxy_kpiders<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">--</span>run_spiders<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">--</span>proxy_test<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">--</span>proxy_api<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">--</span>domain<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">--</span>utils
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">--</span>__init__<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">--</span>http<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">--</span>log<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">--</span>main<span style="color:#ff79c6">.</span>py
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">--</span>settings<span style="color:#ff79c6">.</span>py
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="定义代理ip的数据模型类">定义代理IP的数据模型类<a hidden class="anchor" aria-hidden="true" href="#定义代理ip的数据模型类">#</a></h1>
<ul>
<li>定义Proxy类，继承object</li>
<li>实现_init_方法，负责初始化，包含如下字段：
<ul>
<li>ip：代理的IP地址</li>
<li>port：代理IP的端口号</li>
<li>protocol：代理IP支持的协议类型，http是0，https是1，https和http都支持是2</li>
<li>nick_type：代理IP的匿名程度，高匿：0，匿名：1，透明：2</li>
<li>speed：代理IP的响应速度，单位s</li>
<li>area：代理IP所在地区</li>
<li>score：代理IP的评分，用于衡量代理的可用性；默认分值可以通过配置文件进行配置.在进行代理可用性检查的时候，每遇到一次请求失败就减1份，减到0的时候从池中删除.如果检查代理可用，就恢复默认分值</li>
<li>disable_domains：不可用域名列表，有些代理IP在某些域名下不可用，但是在其他域名下可用</li>
<li>在配置文件：settings.py中定义MAX_SCORE=50，表示代理IP的默认最高分数</li>
</ul>
</li>
<li>提供_str方法，返回数据字符串</li>
</ul>
<h1 id="代理池的工具模块">代理池的工具模块<a hidden class="anchor" aria-hidden="true" href="#代理池的工具模块">#</a></h1>
<p>日志模块</p>
<p>http模块</p>
<h2 id="日志模块">日志模块<a hidden class="anchor" aria-hidden="true" href="#日志模块">#</a></h2>
<ul>
<li>
<p>能够方便的对程序进行调试</p>
</li>
<li>
<p>能够方便记录程序的运行状态</p>
</li>
<li>
<p>能够方便记录错误信息</p>
</li>
<li>
<p>日志的实现</p>
<ul>
<li>目标：实现日志模块，用于记录日志</li>
<li>把日志相关配置信息放到配置文件中</li>
<li>修改日志代码，使用配置文件中的配置信息</li>
</ul>
</li>
</ul>
<h2 id="http模块">Http模块<a hidden class="anchor" aria-hidden="true" href="#http模块">#</a></h2>
<ul>
<li>我在从代理IP网站上抓取代理IP和检验代理IP时候，为了不容易不服务器识别为是一个爬虫，我们最好提供随机的User-Agent请求头.</li>
<li>目标：获取随机User-Agent的请求头
步骤：
1.准备User-Agent的列表
2.实现一个方法，获取随机User-Agent的请求头</li>
</ul>
<h1 id="代理池的检验模块">代理池的检验模块<a hidden class="anchor" aria-hidden="true" href="#代理池的检验模块">#</a></h1>
<ul>
<li>
<p>目标：检查代理IP速度，匿名程度以及支持的协议类型.</p>
</li>
<li>
<p>步骤：</p>
</li>
<li>
<p>检查代理IP速度和匿名程度；</p>
<ul>
<li>
<p>代理IP速度：就是从发送请求到获取响应的时间间隔</p>
</li>
<li>
<p>匿名程度检查：</p>
<ul>
<li>
<p>对http://httpbin.org/get 或https://httpbin.org/get 发送请求</p>
</li>
<li>
<p>如果响应的origin中有 ***，***分割的两个IP就是透明代理IP</p>
</li>
<li>
<p>如果响应的headers 中包含Proxy-Connection 说明是匿名代理IP</p>
</li>
<li>
<p>否则就是高匿代理IP。</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>检查代理IP协议类型</p>
<ul>
<li>如果http://httpbin.org/get 发送请求可以成功，说明支持http协议</li>
</ul>
</li>
<li>
<p>如果https://httpbin.org/get 发送请求可以成功，说明支持https协议</p>
</li>
</ul>
<h1 id="代理池的数据库模块">代理池的数据库模块<a hidden class="anchor" aria-hidden="true" href="#代理池的数据库模块">#</a></h1>
<ul>
<li>作用：用于对proxies集合进行数据库的相关操作</li>
<li>目标：实现对数据库增删改查相关操作、</li>
<li>步骤：
1.在<code>init</code>中，建立数据连接，获取要操作的集合，在<code>del</code>方法中关闭数据库连接
2.提供基础的增删改查功能
<ul>
<li>实现插入功能</li>
<li>实现修改该功能</li>
<li>实现删除代理：根据代理的IP删除代理</li>
<li>查询所有代理IP的功能</li>
</ul>
</li>
<li>3.提供代理API模块使用的功能
<ul>
<li>实现查询功能：根据条件进行查询，可以指定查询数量，先分数降序，速度升序排，保证优质的代理IP在上面.</li>
<li>实现根据协议类型和要访问网站的域名，获取代理IP列表</li>
<li>实现根据协议类型和要访问完整的域名，随机获取一个代理IP</li>
<li>实现把指定域名添加到指定IP的disable_domain列表中.</li>
</ul>
</li>
</ul>
<h1 id="实现代理池的爬虫模块">实现代理池的爬虫模块<a hidden class="anchor" aria-hidden="true" href="#实现代理池的爬虫模块">#</a></h1>
<h2 id="爬虫模块的需求">爬虫模块的需求<a hidden class="anchor" aria-hidden="true" href="#爬虫模块的需求">#</a></h2>
<ul>
<li>需求：抓取各个代理IP网站上的免费代理IP进行检测，如果可用存储到数据库中</li>
<li>需要抓取代理IP的页面如下：
<ul>
<li>西刺代理：https://www.xicidaili.com/nn/1</li>
<li>ip3366代理：http://www.ip3366.net/free/?stype=1&amp;page=1</li>
<li>快代理：https://www.kuaidaili.com/free/inha/1/</li>
<li>oproxylistplus代理:https://list.proxylistplus.com/Fresh-HTTP-Proxy-List-1</li>
<li>66ip代理：http://www.66ip.cn/1.html</li>
</ul>
</li>
</ul>
<h2 id="爬虫模块的设计">爬虫模块的设计<a hidden class="anchor" aria-hidden="true" href="#爬虫模块的设计">#</a></h2>
<ul>
<li>通用爬虫：通过指定URL列表，分组XPATH和组内XPATH，来提取不同网站的代理IP
<ul>
<li>原因代理IP网站的页面结构几乎都是Table，页面结构类似</li>
</ul>
</li>
<li>具体爬虫：用于抓取具体代理IP网站
<ul>
<li>通过继承通用爬虫实现具体网站的抓取，一般只需要指定爬取的URL列表，分组的XPATH和组内XPATH就可以了.</li>
<li>如果该网站有特殊反爬手段，可以通过重写某些方法实现反爬</li>
</ul>
</li>
<li>爬虫运行模块：启动爬虫，抓取代理IP进行检测，如果可用，就存储到数据库中；
<ul>
<li>通过配置文件来控制启动哪些爬虫，增加扩展性；如果将来我们遇到返回<code>json</code>格式的代理网站，单独写一个爬虫配置下就好了.</li>
</ul>
</li>
</ul>
<h2 id="实现通用爬虫">实现通用爬虫<a hidden class="anchor" aria-hidden="true" href="#实现通用爬虫">#</a></h2>
<ul>
<li>
<p>目标：实现可以指定不同URL列表，分组的XPATH和详情的XPATH，从不同页面上提取代理的IP端口号和区域的通用爬虫；</p>
</li>
<li>
<p>步骤：
1.在<code>base_spider.py</code>文件中，定义一个<code>BaseSpider</code>类，继承object
2.提供三个类成员变量：</p>
<ul>
<li>
<p>urls：代理IP网址的URL的列表</p>
</li>
<li>
<p>group_xpath：分组XPATH，获取包含代理IP信息标签列表的XPATH</p>
</li>
<li>
<p>detail_xpath：组内XPATH，获取代理IP详情的信息XPATH，格式为：{&ldquo;ip&rsquo;:&lsquo;xx&rsquo;，&lsquo;port&rsquo;：&lsquo;xx&rsquo;，‘area&rsquo;：&lsquo;xx&rsquo;}</p>
</li>
</ul>
<p>3.提供初始方法，传入爬虫URL列表，分组XPATH，详情（组内）XPATH
4.对外提供一个获取代理IP的方法</p>
<ul>
<li>遍历URL列表，获取URL</li>
<li>根据发送请求，获取页面数据</li>
<li>解析页面，提取数据，封装为Proxy对象</li>
<li>返回Proxy对象列表</li>
</ul>
</li>
</ul>
<h2 id="实现具体爬虫">实现具体爬虫<a hidden class="anchor" aria-hidden="true" href="#实现具体爬虫">#</a></h2>
<ul>
<li>
<p>目标：通过继承通用爬虫，实现多个具体爬虫，分别从各个免费代理IP网站上抓取代理IP</p>
</li>
<li>
<p>1.实现西刺代理爬虫：http://www.xicidaili.com/nn/1</p>
<ul>
<li>定义一个类，继承通用爬虫类（<code>BasicSpider</code>）</li>
<li>提供urls，group_xpath 和detail_xpath</li>
</ul>
</li>
<li>
<p>2.实现ip3366代理爬虫：http://www.ip3366.net/free/？stype=1&amp;page=1</p>
<ul>
<li>定义一个类，继承通用爬虫类（BasicSpider）</li>
<li>提供urls，group_xpath 和detail_xpath</li>
</ul>
</li>
<li>
<p>3.实现快代理爬虫：https://www.kuaidaili.com/free/inha/1/</p>
<ul>
<li>定义一个类，继承通用爬虫类（BasicSpider）</li>
<li>提供urls，group_xpath和detail_xpath</li>
</ul>
</li>
<li>
<p>4.实现 proxylistplus代理爬虫：https://list.proxylistplus.com/Fresh-HTTP-Proxy-List-1</p>
<ul>
<li>定义一个类，继承通用爬虫类（BasicSpider）</li>
<li>提供urls，group_xpath 和detail_xpath</li>
</ul>
</li>
<li>
<p>5.实现66ip爬虫：http://www.66ip.cn/1.html</p>
<ul>
<li>定义一个类，继承通用爬虫类（BasicSpider）</li>
<li>提供urls，group_xpath和detail_xpath</li>
<li>由于66ip网页进行js+cookie反爬，需要重写父类的get_page_from_url 方法</li>
</ul>
<p>PS：实现66ip爬虫：http://www.66ip.cn/1.html核心：</p>
<p>通过加密的js，生成需要cookie信息
1.从响应页面中，提取：</p>
<p>​			1.执行生成真正js语句</p>
<p>​			2.生成真正js的函数.</p>
<p>2.网页中，是通过<code>eval</code>执行真正js，加载页面；而我们要获取真正的js；我们就需要把<code>eval</code>语句，替换为return，把真正js返回.</p>
<p>3.使用<code>js2py</code>，获取执行js的环境，使用js执行环境加载这个函数</p>
<p>4.使用这个执行环境，执行调用调用，生成真正js，赋值给一个变量</p>
<p>5.从真正的js代码中，提取我们需要cookie信息.</p>
</li>
</ul>
<h1 id="实现爬虫的运行模块">实现爬虫的运行模块<a hidden class="anchor" aria-hidden="true" href="#实现爬虫的运行模块">#</a></h1>
<ul>
<li>目标：根据配置文件信息，加载爬虫，抓取代理IP，进行校验，如果可用，写入到数据库中</li>
<li>思路：
<ul>
<li>在<code>run_spider.py</code>中，创建<code>RunSpider</code>类</li>
</ul>
</li>
<li>提供一个运行爬虫的run方法，作为运行爬虫的入口，实现核心的处理逻辑
<ul>
<li>根据配置文件信息，获取爬虫对象列表.</li>
<li>遍历爬虫对象列表，获取爬虫对象，遍历爬虫对象的get_proxies方法，获取代理IP</li>
<li>检测代理IP（代理IP检测模块）</li>
<li>如果可用，写入数据库（数据库模块）</li>
<li>处理异常，防止一个爬虫内部出错了，影响其他的爬虫.</li>
</ul>
</li>
<li>使用异步来执行每一个爬虫任务，以提高抓取代理IP效率
<ul>
<li>在init 方法中创建协程池对象</li>
<li>把处理一个代理爬虫的代码抽到一个方法</li>
<li>使用异步执行这个方法</li>
<li>调用协程的join方法，让当前线程等待队列任务的完成.</li>
</ul>
</li>
<li>使用<code>schedule</code>模块，实现每隔一定的时间，执行一次爬取任务
<ul>
<li>定义一个start的类方法</li>
<li>创建当前类的对象，调用run方法</li>
<li>使用schedule模块，每隔一定的时间，执行当前对象的run方法</li>
</ul>
</li>
</ul>
<h1 id="实现代理池的检测模块">实现代理池的检测模块<a hidden class="anchor" aria-hidden="true" href="#实现代理池的检测模块">#</a></h1>
<ul>
<li>
<p>目的：检查代理IP可用性，保证代理池中代理IP基本可用</p>
</li>
<li>
<p>思路</p>
<ul>
<li>
<p>1.在<code>proxy_test.py</code>中，创建<code>Proxy Tester</code>类</p>
</li>
<li>
<p>2.提供一个run 方法，用于处理检测代理命核心逻辑</p>
<ul>
<li>
<p>从数据库中获取所有代理IP</p>
</li>
<li>
<p>遍历代理IP列表</p>
</li>
<li>
<p>检查代理可用性</p>
<ul>
<li>
<p>如果代理不可用，让代理分数-1，如果代理分数等于0就从数据库中删除该代理，否则更新该代理IP</p>
</li>
<li>
<p>如果代理可用，就恢复该代理的分数，更新到数据库中</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>3.为了提高检查的速度，使用异步来执行检测任务</p>
<ul>
<li>
<p>在<code>init</code>方法中，创建队列和协程池</p>
<ul>
<li>把要检测的代理IP，放到队列中</li>
<li>i.把检查一个代理可用性的代码，抽取到一个方法中；从队列中获取代理IP，进行检查；检查完毕，调度队列的task_done方法</li>
<li>ii.通过异步回调，使用死循环不断执行这个方法，</li>
<li>iv.开启多个一个异步任务，来处理代理IP的检测；可以通过配置文件指定异步数量</li>
<li>调用队列的join方法，让当前线程等待队列任务完成</li>
</ul>
</li>
</ul>
<p>4.使用schedule模块，每隔一定的时间，执行一次检测任务</p>
<ul>
<li>定义类方法start，用于启动检测模块</li>
<li>在start方法中
<ul>
<li>i.创建本类对象</li>
<li>i.调用run方法</li>
<li>i.每间隔一定时间，执行一下，run方法</li>
</ul>
</li>
</ul>
<h1 id="实现代理池的api模块">实现代理池的API模块<a hidden class="anchor" aria-hidden="true" href="#实现代理池的api模块">#</a></h1>
<ul>
<li>
<p>目标：</p>
<ul>
<li>为爬虫提供高可用代理IP的服务接口</li>
</ul>
</li>
<li>
<p>步骤：</p>
<ul>
<li>
<p>实现根据协议类型和域名，提供随机的获取高可用代理IP的服务</p>
</li>
<li>
<p>实现根据协议类型和域名，提供获取多个高可用代理IP的服务</p>
</li>
<li>
<p>实现给指定的IP上追加不可用域名的服务</p>
</li>
</ul>
</li>
<li>
<p>实现</p>
<ul>
<li>在<code>proxy_api.py</code>中，创建<code>ProxyApi</code>类</li>
</ul>
</li>
<li>
<p>实现初始方法s</p>
<ul>
<li>
<p>初始一个Flask的Web服务</p>
</li>
<li>
<p>实现根据协议类型和域名，提供随机的获取高可用代理IP的服务</p>
<ul>
<li>
<p>可用通过protocol和domain参数对IP进行过滤</p>
</li>
<li>
<p>protocol：当前请求的协议类型</p>
</li>
<li>
<p>domain：当前请求域名</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>实现根据协议类型和域名，提供获取多个高可用代理IP的服务·</p>
<ul>
<li>可用通过protocol和domain参数对IP进行过滤</li>
</ul>
</li>
<li>
<p>实现给指定的IP上追加不可用域名的服务</p>
<ul>
<li>如果在获取IP的时候，有指定域名参数，将不在获取该IP从而进一步提高代理IP的可用性.</li>
</ul>
</li>
<li>
<p>实现run方法，用于启动Flask的WEB服务</p>
</li>
<li>
<p>实现start的类方法，用于通过类名，启动服务</p>
</li>
</ul>
<h1 id="实现代理池的程序入口">实现代理池的程序入口<a hidden class="anchor" aria-hidden="true" href="#实现代理池的程序入口">#</a></h1>
<ul>
<li>目标：把<code>启动爬虫</code>，<code>启动检测代理IP</code>，<code>启动WEB服务</code>统一到一起</li>
<li>思路：
<ul>
<li>开启三个进程，分别用于启动爬虫，检测代理IP，WEB服务</li>
</ul>
</li>
<li>步骤：</li>
<li>定义一个run方法用于启动动代理池
<ul>
<li>定义一个列表，用于存储要启动的进程</li>
<li>创建<code>启动爬虫</code>的进程，添加到列表中</li>
<li>创建<code>启动检测</code>的进程，添加到列表中</li>
<li>创建<code>启动提供API</code>服务的进程，添加到列表中</li>
<li>遍历进程列表，启动所有进程</li>
<li>遍历进程列表，让主进程等待子进程的完成</li>
</ul>
</li>
<li>在<code>if__name__=='__main__'：</code>中调用run方法</li>
</ul>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E7%88%AC%E8%99%AB%E5%AE%9E%E8%B7%B5/">爬虫实践</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Luenci</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
